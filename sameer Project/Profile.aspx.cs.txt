using Railway_Management_System.DAL;
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data.SqlClient;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;

namespace Railway_Management_System
{
    public partial class Profile : BasePage
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            if (Users.IsLoggedIn())
            {
                lnk.Text = Users.Instance.FullName;
                lnk.NavigateUrl = "Profile.aspx"; // Assuming the profile page is named profile.aspx
            }
            else
            {
                lnk.Text = "Login";
                lnk.NavigateUrl = "Login.aspx"; // Assuming the login page is named login.aspx
            }

            string fullName = ""; // Get from database
            string phoneNumber = ""; // Get from database
            string cnic = ""; // Get from database
            string email = ""; // Get from database
            string points = ""; // Get from database
            string img = "";

            string connectionString = ConfigurationManager.ConnectionStrings["sqlCon1"].ConnectionString;
            using (SqlConnection connection = new SqlConnection(connectionString))
            {
                connection.Open();
                string query = "SELECT FName , LName , PhoneNo , Email , CNIC , Points , Image FROM Traveller WHERE ID = @UserId"; // Assuming you have a Users table with a PhotoPath column
                SqlCommand command = new SqlCommand(query, connection);
                command.Parameters.AddWithValue("@UserId", CurrentUser.ID); // Replace with the actual user id
                SqlDataReader reader = command.ExecuteReader();
                if (reader.Read())
                {
                    string fn = reader["FName"].ToString();
                    string ln = reader["LName"].ToString();
                    fullName = fn + " " + ln;
                    phoneNumber = reader["PhoneNo"].ToString();
                    cnic = reader["CNIC"].ToString();
                    email = reader["Email"].ToString();
                    points = reader["Points"].ToString();
                    img = reader["Image"].ToString();
                }
                connection.Close();
            }


            lblFullName.Text = fullName;
            lblPhoneNumber.Text = phoneNumber;
            lblCnic.Text = cnic;
            lblEmail.Text = email;
            lblPoints.Text = points;

            // Set the profile photo
            if(img == "")
            {
                profilePhoto.ImageUrl = "/Images/dpp.jpg"; // Default photo path
            }
            else
            {
                profilePhoto.ImageUrl = img;
            }
            
        }

        protected void btnUpload_Click(object sender, EventArgs e)
        {
            if (fileToUpload.HasFile)
            {
                // Save the file to the server
                string filename = System.IO.Path.GetFileName(fileToUpload.FileName);
                string filePath = "~/Images/" + filename;
                fileToUpload.SaveAs(Server.MapPath(filePath));

                // Insert the file path into the database
                // Assuming you have a method to insert data into the database
                // Here's a simplified example using ADO.NET
                string connectionString = ConfigurationManager.ConnectionStrings["sqlCon1"].ConnectionString;
                using (SqlConnection connection = new SqlConnection(connectionString))
                {
                    connection.Open();
                    string query = "UPDATE Traveller SET Image = @FilePath WHERE ID = @UserId"; // Assuming you have a Users table with a PhotoPath column
                    SqlCommand command = new SqlCommand(query, connection);
                    command.Parameters.AddWithValue("@FilePath", filePath);
                    command.Parameters.AddWithValue("@UserId", CurrentUser.ID); // Replace with the actual user id
                    command.ExecuteNonQuery();
                }

                // Update the profile photo path in the database
                // You can also update the profilePhoto.ImageUrl here to display the uploaded photo
                profilePhoto.ImageUrl = filePath;
            }
        }

        protected void Logout(object sender , EventArgs e)
        {
            Users.Logout();
            Response.Redirect("Main Page.aspx");
        }
    }
}